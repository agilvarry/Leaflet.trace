L.Draw.Trace=L.Draw.Polyline.extend({statics:{TYPE:"trace"},options:{allowIntersection:true,repeatMode:false,drawError:{color:"#b00b00",timeout:2500},icon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon"}),touchIcon:new L.DivIcon({iconSize:new L.Point(20,20),className:"leaflet-div-icon leaflet-editing-icon leaflet-touch-icon"}),guidelineDistance:20,maxGuideLineLength:4e3,shapeOptions:{stroke:true,color:"red",weight:4,opacity:.5,fill:false,clickable:true},metric:true,feet:true,nautic:false,zIndexOffset:2e3,factor:1,maxPoints:0},initialize:function(map,options){L.Draw.Polyline.prototype.initialize.call(this,map,options);this.type=L.Draw.Trace.TYPE;this.options.drawError.message="You must draw over the selected line."},addHooks:function(){L.Draw.Polyline.prototype.addHooks.call(this);this.almostLatLng=false;this._map.on("almost:move",this._almostMove,this).on("almost:out",this._almostOut,this);let s;this._map.eachLayer(function(layer){if(layer.options.name&&layer.options.name=="selected"){s=layer}});this.selected=s;this.lineType=s.options.lineType;if(this.lineType=="MultiLineString"){this.getSegments(s)}},getSegments:function(s){this.segments=s.getLatLngs().map(ll=>L.polyline(ll))},removeHooks:function(){L.Draw.Polygon.prototype.removeHooks.call(this);delete this.selected;delete this.almostLatLng;delete this.startRatio;delete this.linestart;delete this._clickHandled;delete this._disableMarkers;delete this.segments;delete this.closest;delete this.lineType;this._map.off("almost:move",this._almostMove,this).off("almost:out",this._almostOut,this)},_almostOut:function(e){this.almostLatLng=false},_almostMove:function(e){this.almostLatLng=e.latlng},addVertex:function(latlng){const markersLength=this._markers.length;if(markersLength>=2&&!this.options.allowIntersection&&this._poly.newLatLngIntersects(latlng)||!latlng){this._showErrorTooltip();return}else if(this._errorShown){this._hideErrorTooltip()}else{const endRatio=L.GeometryUtil.locateOnLine(this._map,this.closest,this.almostLatLng);const extraction=L.GeometryUtil.extract(this._map,this.closest,this.startRatio,endRatio);this._markers=extraction.map(e=>this._createMarker(e));this._poly.setLatLngs(extraction);if(this._poly.getLatLngs().length===2){this._map.addLayer(this._poly)}this._vertexChanged(latlng,true)}},_onMouseMove:function(e){L.Draw.Polyline.prototype._onMouseMove.call(this,e);if(this.lineStart){this.addVertex(this.almostLatLng)}},_onMouseDown:function(e){if(!this._clickHandled&&!this._touchHandled&&!this._disableMarkers&&this.almostLatLng!=false){this._map.dragging.disable();this._onMouseMove(e);this._clickHandled=true;this._disableNewMarkers();this.lineStart=true;this.closest=this._setClosest();this.startRatio=L.GeometryUtil.locateOnLine(this._map,this.closest,this.almostLatLng);this._startPoint.call(this,this.almostLatLng.lng,this.almostLatLng.lat)}},_latlngToArray:function(lls){if(Array.isArray(lls))return lls.map(ll=>this._latlngToArray(ll));else return[lls.lng,lls.lat]},_setClosest:function(){if(this.lineType=="LineString"){return this.selected}else{return L.GeometryUtil.closestLayer(this._map,this.segments,this.almostLatLng).layer}},_onMouseUp:function(e){L.Draw.Polyline.prototype._onMouseUp.call(this,e);this._map.dragging.enable();this.lineStart=false},_endPoint:function(_clientX,_clientY,_e){if(this._mouseDownOrigin){this._finishShape();this._enableNewMarkers()}this._mouseDownOrigin=null},_createMarker:function(latlng){var marker=new L.Marker(latlng,{icon:this.options.icon,zIndexOffset:this.options.zIndexOffset*2});return marker},_updateRunningMeasure:function(_latlng,_added){this._measurementRunningTotal=0;if(this._markers.length>1){for(let i=1;i<this._markers.length;i++){this._measurementRunningTotal+=this._map.distance(this._markers[i-1].getLatLng(),this._markers[i].getLatLng())*(this.options.factor||1)}}}});L.Draw.Select=L.Draw.Rectangle.extend({statics:{TYPE:"select"},initialize:function(map,options){L.Draw.Rectangle.prototype.initialize.call(this,map,options);this._map=map;this._initialLabelText="Click and drag to select a line.";this.options.showArea=false;this.type=L.Draw.Select.TYPE},addHooks:function(){L.Draw.Rectangle.prototype.addHooks.call(this);let s;this._map.eachLayer(function(layer){if(layer.options.name&&layer.options.name=="selected"){s=layer}});this.selected=s;this._map.on(L.Draw.Event.CREATED,this._created,this)},_enableSelect:function(){const button=document.getElementsByClassName("leaflet-draw-draw-trace")[0];if(button){button.className="leaflet-draw-draw-trace-active"}},removeHooks:function(){L.Draw.Rectangle.prototype.removeHooks.call(this);delete this.selected;this._map.off(L.Draw.Event.CREATED,this._created,this)},_latlngToArray:function(lls){if(Array.isArray(lls))return lls.map(ll=>this._latlngToArray(ll));else return[lls.lng,lls.lat]},_created:function(e){const latlngs=this._latlngToArray(e.layer.getLatLngs());latlngs[0].push(latlngs[0][0]);const selectPoly=turf.polygon(latlngs);this._map.eachLayer(layer=>{if(layer.options.selectable){this._manageSelect(selectPoly,layer)}})},_manageSelect:function(rect,selectable){if(this.selected){this._map.almostOver.removeLayer(this.selected);this._map.removeLayer(this.selected)}let selected;selectable.eachLayer(layer=>{let line=this._grabTurfLine(layer);if(line){const intersect=turf.booleanIntersects(rect,line);if(intersect){selected=layer}}});if(selected){this._drawSelect(selected)}},_grabTurfLine:function(layer){const lineType=layer.feature.geometry.type;const latlngs=this._latlngToArray(layer.getLatLngs());if(lineType=="LineString"){return turf.lineString(latlngs)}else if(lineType=="MultiLineString"){return turf.multiLineString(latlngs)}return line},_drawSelect:function(selected){let properties={};if(selected.feature.properties){properties=selected.feature.properties}this.selected=L.polyline(selected.getLatLngs(),{weight:4,color:"gold",name:"selected",lineType:selected.feature.geometry.type,properties:properties}).addTo(this._map);this._map.addLayer(this.selected);this._map.almostOver.addLayer(this.selected);this._enableSelect()}});L.Draw.Unselect=L.Handler.extend({statics:{TYPE:"unselect"},initialize:function(map,options){this._map=map;this.type=L.Draw.Unselect.TYPE;L.setOptions(this,options);var version=L.version.split(".");if(parseInt(version[0],10)===1&&parseInt(version[1],10)>=2){L.Draw.Unselect.include(L.Evented.prototype)}else{L.Draw.Unselect.include(L.Mixin.Events)}},disableSelect:function(){const button=document.getElementsByClassName("leaflet-draw-draw-trace-active")[0];if(button){button.className="leaflet-draw-draw-trace"}},unselect:function(){if(this.selected){this._map.almostOver.removeLayer(this.selected);this._map.removeLayer(this.selected);this.disableSelect()}},enable:function(){if(this._enabled){return}L.Handler.prototype.enable.call(this);this.fire("enabled",{handler:this.type})},disable:function(){if(!this._enabled){return}L.Handler.prototype.disable.call(this);this.fire("disabled",{handler:this.type})},addHooks:function(){if(this._map){let s;this._map.eachLayer(function(layer){if(layer.options.name&&layer.options.name=="selected"){s=layer}});this.selected=s}this.unselect()},removeHooks:function(){if(this._map){delete this.selected}}});L.TraceToolbar=L.Toolbar.extend({statics:{TYPE:"trace"},options:{select:{},unselect:{},trace:{}},initialize:function(options){for(var type in this.options){if(this.options.hasOwnProperty(type)){if(options[type]){options[type]=L.extend({},this.options[type],options[type])}}}this._toolbarClass="leaflet-draw-draw";L.Toolbar.prototype.initialize.call(this,options)},getModeHandlers:function(map){return[{enabled:true,handler:new L.Draw.Select(map),title:"Select a line to trace"},{enabled:true,handler:new L.Draw.Unselect(map),title:"Remove line selection"},{enabled:true,handler:new L.Draw.Trace(map),title:"Trace a line"}]},getActions:function(handler){return[{enabled:handler.type=="unselect"?false:true,title:L.drawLocal.draw.toolbar.actions.title,text:L.drawLocal.draw.toolbar.actions.text,callback:this.disable,context:this}]}});L.Control.Trace=L.Control.Draw.extend({initialize:function(options){if(L.version<"0.7"){throw new Error("Leaflet.draw 0.2.3+ requires Leaflet 0.7.0+. Download latest from https://github.com/Leaflet/Leaflet/")}L.Control.prototype.initialize.call(this,options);var toolbar;this._toolbars={};if(L.TraceToolbar&&this.options.trace){toolbar=new L.TraceToolbar(this.options.draw);this._toolbars[L.TraceToolbar.TYPE]=toolbar;this._toolbars[L.TraceToolbar.TYPE].on("enable",this._toolbarEnabled,this)}if(L.DrawToolbar&&this.options.draw){toolbar=new L.DrawToolbar(this.options.draw);this._toolbars[L.DrawToolbar.TYPE]=toolbar;this._toolbars[L.DrawToolbar.TYPE].on("enable",this._toolbarEnabled,this)}if(L.EditToolbar&&this.options.edit){toolbar=new L.EditToolbar(this.options.edit);this._toolbars[L.EditToolbar.TYPE]=toolbar;this._toolbars[L.EditToolbar.TYPE].on("enable",this._toolbarEnabled,this)}L.toolbar=this}});